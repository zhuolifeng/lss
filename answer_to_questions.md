# å…³é”®é—®é¢˜æ·±åº¦è§£ç­”

## 1. é©¬å°”å¯å¤«æ€§è´¨ï¼ˆMDPæ€§è´¨ï¼‰ä¸é•¿æœŸæ—¶åºä¿¡æ¯çš„çŸ›ç›¾è§£å†³

### 1.1 é—®é¢˜çš„æ ¸å¿ƒ

æ‚¨æå‡ºçš„é—®é¢˜éå¸¸æ·±åˆ»ï¼ç¡®å®ï¼Œåœ¨ç»å…¸HMMä¸­ï¼š
- **é©¬å°”å¯å¤«æ€§è´¨**ï¼šP(Xt+1|Xt, Xt-1, ..., X1) = P(Xt+1|Xt)
- **å«ä¹‰**ï¼šæœªæ¥çŠ¶æ€åªä¾èµ–å½“å‰çŠ¶æ€ï¼Œä¸ä¾èµ–å†å²çŠ¶æ€

ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„è®¾è®¡ä¸­ä½¿ç”¨äº†"é•¿æœŸæ—¶åºä¿¡æ¯"ï¼Œè¿™çœ‹èµ·æ¥ç¡®å®ä¸é©¬å°”å¯å¤«æ€§è´¨å†²çªã€‚

### 1.2 è§£å†³æ–¹æ¡ˆï¼šå¤åˆéšçŠ¶æ€

**å…³é”®æ´å¯Ÿ**ï¼šé©¬å°”å¯å¤«æ€§è´¨çš„å…³é”®åœ¨äº**å¦‚ä½•å®šä¹‰"çŠ¶æ€"**ï¼

æˆ‘ä»¬çš„åˆ›æ–°è§£å†³æ–¹æ¡ˆï¼š
```python
# ä¼ ç»Ÿæ–¹æ³•ï¼ˆè¿åé©¬å°”å¯å¤«æ€§è´¨ï¼‰
Xt+1 = f(Xt, Xt-1, Xt-2, ..., At)  # ç›´æ¥ä¾èµ–å†å²

# æˆ‘ä»¬çš„æ–¹æ³•ï¼ˆç¬¦åˆé©¬å°”å¯å¤«æ€§è´¨ï¼‰
Ht+1 = g(Ht, Ot, At)  # éšçŠ¶æ€æ›´æ–°ï¼Œåªä¾èµ–å½“å‰éšçŠ¶æ€
Xt+1 = h(Ht+1)        # è§‚æµ‹ä»éšçŠ¶æ€ç”Ÿæˆ

# å…¶ä¸­ï¼š
# Ht = å¤åˆéšçŠ¶æ€ï¼ˆç¼–ç äº†æ‰€æœ‰å†å²ä¿¡æ¯ï¼‰
# Ot = å½“å‰è§‚æµ‹
# At = å½“å‰åŠ¨ä½œ
```

### 1.3 å¤åˆéšçŠ¶æ€çš„æ„æˆ

```python
class MarkovianHiddenState:
    """
    å¤åˆéšçŠ¶æ€åŒ…å«ï¼š
    1. current_hidden_state: å½“å‰çŠ¶æ€ç¼–ç 
    2. world_memory: ä¸–ç•ŒçŠ¶æ€è®°å¿†ï¼ˆå‹ç¼©çš„å†å²ä¿¡æ¯ï¼‰
    3. state_quality: çŠ¶æ€è´¨é‡è¯„ä¼°
    """
    
    def update_state(self, current_obs, current_action):
        # é©¬å°”å¯å¤«è½¬ç§»ï¼šæ–°çŠ¶æ€åªä¾èµ–å½“å‰éšçŠ¶æ€å’Œå½“å‰è§‚æµ‹
        new_hidden_state = self.state_update_net(
            [current_obs, current_action, self.current_hidden_state]
        )
        # å†å²ä¿¡æ¯å·²ç»ç¼–ç åœ¨current_hidden_stateä¸­ï¼
```

### 1.4 æ•°å­¦è¡¨ç¤º

**ç¬¦åˆé©¬å°”å¯å¤«æ€§è´¨çš„è¡¨ç¤º**ï¼š
```
çŠ¶æ€å®šä¹‰ï¼šSt = (Ht, Wt, Qt)
å…¶ä¸­ï¼š
- Ht: éšçŠ¶æ€ï¼ˆç¼–ç å†å²ä¿¡æ¯ï¼‰
- Wt: ä¸–ç•ŒçŠ¶æ€è®°å¿†
- Qt: çŠ¶æ€è´¨é‡

è½¬ç§»æ–¹ç¨‹ï¼š
St+1 = T(St, Ot, At)  # åªä¾èµ–å½“å‰çŠ¶æ€ï¼

è§‚æµ‹æ–¹ç¨‹ï¼š
Xt+1 = E(St+1)
```

**è¿™æ ·å°±å®Œç¾è§£å†³äº†çŸ›ç›¾**ï¼š
- âœ… ç¬¦åˆé©¬å°”å¯å¤«æ€§è´¨ï¼šè½¬ç§»åªä¾èµ–å½“å‰çŠ¶æ€
- âœ… åˆ©ç”¨å†å²ä¿¡æ¯ï¼šå†å²ä¿¡æ¯ç¼–ç åœ¨éšçŠ¶æ€ä¸­
- âœ… ç†è®ºä¸¥è°¨ï¼šç¬¦åˆHMMçš„æ•°å­¦å®šä¹‰

## 2. åŒTransitionåˆ›æ–°èåˆç­–ç•¥

### 2.1 åˆ›æ–°ç‚¹åˆ†æ

æˆ‘ä»¬çš„åŒtransitionä¸ä»…ä»…æ˜¯ä¸ºäº†**é²æ£’æ€§**ï¼Œæ›´é‡è¦çš„æ˜¯**åˆ›æ–°æ€§**ï¼š

#### ä¼ ç»Ÿæ–¹æ³•çš„å±€é™ï¼š
- **å•ä¸€æŠ½è±¡å±‚æ¬¡**ï¼šè¦ä¹ˆåœ¨è§†è§’ç©ºé—´ï¼Œè¦ä¹ˆåœ¨BEVç©ºé—´
- **ä¿¡æ¯å­¤ç«‹**ï¼šä¸åŒç©ºé—´çš„ä¿¡æ¯æ— æ³•æœ‰æ•ˆäº¤äº’
- **ç¼ºä¹å±‚æ¬¡æ€§**ï¼šæ²¡æœ‰è€ƒè™‘ä¸åŒå±‚æ¬¡çš„å‡ ä½•è¯­ä¹‰

#### æˆ‘ä»¬çš„åˆ›æ–°è®¾è®¡ï¼š
```python
# Transition1: è§†è§’ç©ºé—´çš„å‡ ä½•è½¬ç§»
Lift_enhanced = Transition1(Lift_current, Hidden_state)

# Transition2: BEVç©ºé—´çš„è¯­ä¹‰è½¬ç§»  
Splat_enhanced = Transition2(Lift_current, Splat_current, Actions)

# æ ¸å¿ƒåˆ›æ–°ï¼šåŒtransitionåˆ›æ–°èåˆ
Final_features = DualFusion(Lift_enhanced, Splat_enhanced)
```

### 2.2 ä¸‰ç§åˆ›æ–°èåˆç­–ç•¥

#### ç­–ç•¥1ï¼šHierarchicalï¼ˆå±‚æ¬¡åŒ–ï¼‰- æœ€åˆ›æ–°
```python
def hierarchical_fusion(self, t1_out, t2_out, lift, splat):
    """
    åˆ›æ–°ç‚¹ï¼šTransition1çš„è¾“å‡ºå½±å“Transition2çš„è¡Œä¸º
    å‡ ä½•è¯­ä¹‰ï¼šè§†è§’å‡ ä½•ä¿¡æ¯æŒ‡å¯¼BEVè¯­ä¹‰ç†è§£
    """
    # 1. è·¨ç©ºé—´å½±å“ï¼šè§†è§’ç‰¹å¾å½±å“BEVç‰¹å¾
    cross_influence = self.cross_influence_net(t1_out)
    enhanced_t2_out = t2_out + self.cross_influence * cross_influence
    
    # 2. åˆ›æ–°æ€§äº¤äº’ï¼šåŒå‘ä¿¡æ¯æµ
    combined = torch.cat([t1_out, enhanced_t2_out], dim=-1)
    innovation = self.innovation_interaction(combined)
    
    # 3. åˆ†å±‚å¢å¼ºï¼šåˆ†åˆ«å¢å¼ºä¸åŒç©ºé—´çš„ç‰¹å¾
    lift_innovation, splat_innovation = torch.chunk(innovation, 2, dim=-1)
    
    return {
        'enhanced_lift': t1_out + lift_innovation,
        'enhanced_splat': enhanced_t2_out + splat_innovation,
        'cross_influence': cross_influence,
        'innovation': innovation
    }
```

**åˆ›æ–°ä¼˜åŠ¿**ï¼š
- ğŸ”¥ **è·¨ç©ºé—´ä¿¡æ¯æµ**ï¼šè§†è§’å‡ ä½•ä¿¡æ¯ç›´æ¥æŒ‡å¯¼BEVè¯­ä¹‰
- ğŸ”¥ **å±‚æ¬¡åŒ–ç†è§£**ï¼šä»å‡ ä½•åˆ°è¯­ä¹‰çš„å±‚æ¬¡åŒ–å»ºæ¨¡
- ğŸ”¥ **åŒå‘å¢å¼º**ï¼šä¸¤ä¸ªtransitionäº’ç›¸ä¿ƒè¿›

#### ç­–ç•¥2ï¼šParallelï¼ˆå¹¶è¡Œï¼‰- å¹³è¡¡åˆ›æ–°
```python
def parallel_fusion(self, t1_out, t2_out, lift, splat):
    """
    åˆ›æ–°ç‚¹ï¼šæ™ºèƒ½æƒé‡å­¦ä¹ ï¼ŒåŠ¨æ€å¹³è¡¡ä¸¤ä¸ªtransition
    """
    # å­¦ä¹ åŠ¨æ€èåˆæƒé‡
    fusion_weights = self.fusion_weight_net(torch.cat([t1_out, t2_out], dim=-1))
    
    # æ™ºèƒ½åŠ æƒèåˆ
    enhanced_lift = fusion_weights[:, 0:1] * lift + fusion_weights[:, 1:2] * t1_out
    enhanced_splat = fusion_weights[:, 0:1] * splat + fusion_weights[:, 1:2] * t2_out
```

#### ç­–ç•¥3ï¼šCascadeï¼ˆçº§è”ï¼‰- åºåˆ—åˆ›æ–°
```python
def cascade_fusion(self, t1_out, t2_out, lift, splat):
    """
    åˆ›æ–°ç‚¹ï¼šåºåˆ—å¼ä¿¡æ¯ä¼ é€’ï¼Œå±‚å±‚é€’è¿›
    """
    # ç¬¬ä¸€çº§ï¼šliftç‰¹å¾å¢å¼º
    enhanced_lift = lift + t1_out
    
    # ç¬¬äºŒçº§ï¼šåŸºäºå¢å¼ºliftçš„splatå¢å¼º
    lift_influence = self.cross_influence_net(enhanced_lift)
    enhanced_splat = splat + t2_out + self.cross_influence * lift_influence
```

### 2.3 åˆ›æ–°æ€§ä½“ç°

1. **è·¨ç©ºé—´å»ºæ¨¡**ï¼šé¦–æ¬¡åœ¨è§†è§’ç©ºé—´å’ŒBEVç©ºé—´åŒæ—¶å»ºæ¨¡æ—¶åºä¾èµ–
2. **å±‚æ¬¡åŒ–äº¤äº’**ï¼šä¸åŒæŠ½è±¡å±‚æ¬¡çš„ç‰¹å¾ç›¸äº’å½±å“
3. **åŠ¨æ€æƒé‡å­¦ä¹ **ï¼šæ ¹æ®è¾“å…¥åŠ¨æ€è°ƒæ•´èåˆç­–ç•¥
4. **åˆ›æ–°æ€§äº¤äº’æ¨¡å—**ï¼šä¸“é—¨è®¾è®¡çš„åŒtransitionäº¤äº’æœºåˆ¶

## 3. éšçŠ¶æ€çš„å®šä¹‰ä¸ä½¿ç”¨

### 3.1 éšçŠ¶æ€çš„å‡†ç¡®å®šä¹‰

**éšçŠ¶æ€ä¸æ˜¯ç®€å•çš„ç‰¹å¾å‘é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªå¤åˆçŠ¶æ€**ï¼š

```python
class MarkovianHiddenState:
    """
    éšçŠ¶æ€ = {
        current_hidden_state: å½“å‰çŠ¶æ€ç¼–ç  [B, hidden_dim]
        world_memory: ä¸–ç•ŒçŠ¶æ€è®°å¿† [B, world_dim]  
        state_quality: çŠ¶æ€è´¨é‡è¯„ä¼° [B, 1]
    }
    """
```

### 3.2 éšçŠ¶æ€çš„ä¸‰å±‚å«ä¹‰

#### ç¬¬ä¸€å±‚ï¼šå½“å‰çŠ¶æ€ç¼–ç 
- **ä½œç”¨**ï¼šç¼–ç å½“å‰æ—¶åˆ»çš„çŠ¶æ€ä¿¡æ¯
- **æ›´æ–°**ï¼šåŸºäºå½“å‰è§‚æµ‹å’Œå†å²çŠ¶æ€
- **æ•°å­¦**ï¼šHt = f(Ht-1, Ot, At)

#### ç¬¬äºŒå±‚ï¼šä¸–ç•ŒçŠ¶æ€è®°å¿†
- **ä½œç”¨**ï¼šå‹ç¼©å­˜å‚¨å†å²ä¿¡æ¯
- **æ›´æ–°**ï¼šæ¸è¿›å¼æ›´æ–°ï¼Œä¿ç•™é‡è¦å†å²
- **æ•°å­¦**ï¼šWt = g(Wt-1, Ht)

#### ç¬¬ä¸‰å±‚ï¼šçŠ¶æ€è´¨é‡è¯„ä¼°
- **ä½œç”¨**ï¼šè¯„ä¼°å½“å‰çŠ¶æ€çš„å¯é æ€§
- **æ›´æ–°**ï¼šåŸºäºçŠ¶æ€ä¸€è‡´æ€§å’Œé¢„æµ‹è¯¯å·®
- **æ•°å­¦**ï¼šQt = h(Ht, Wt)

### 3.3 éšçŠ¶æ€çš„ä½¿ç”¨æ–¹å¼

```python
def forward(self, lift_features, splat_features, actions):
    # 1. éšçŠ¶æ€æ›´æ–°ï¼ˆé©¬å°”å¯å¤«è½¬ç§»ï¼‰
    state_info = self.markovian_state.update_state(
        lift_features, splat_features, actions
    )
    
    # 2. åŸºäºéšçŠ¶æ€çš„ç‰¹å¾è½¬ç§»
    lift_with_state = torch.cat([
        lift_features, state_info['hidden_state']
    ], dim=-1)
    
    # 3. Transition1ä½¿ç”¨éšçŠ¶æ€
    transition1_output = self.transition1(lift_with_state)
    
    # 4. Transition2ä¹Ÿä½¿ç”¨éšçŠ¶æ€ï¼ˆé€šè¿‡å½“å‰ç‰¹å¾é—´æ¥ä½¿ç”¨ï¼‰
    transition2_output = self.transition2(lift_features, splat_features, actions)
```

### 3.4 éšçŠ¶æ€çš„å…³é”®ä¼˜åŠ¿

1. **é©¬å°”å¯å¤«æ€§è´¨**ï¼šç¬¦åˆHMMç†è®ºè¦æ±‚
2. **å†å²ä¿¡æ¯ç¼–ç **ï¼šä¸ä¸¢å¤±é•¿æœŸä¾èµ–
3. **åŠ¨æ€æ›´æ–°**ï¼šæ ¹æ®å½“å‰ä¿¡æ¯è°ƒæ•´çŠ¶æ€
4. **è´¨é‡è¯„ä¼°**ï¼šæä¾›çŠ¶æ€å¯é æ€§æŒ‡æ ‡

## 4. Transitionè¾“å‡ºå½¢å¼ï¼šDelta vs Absolute

### 4.1 è¾“å‡ºå½¢å¼çš„é€‰æ‹©

æˆ‘ä»¬æ”¯æŒä¸¤ç§è¾“å‡ºå½¢å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ§åˆ¶ï¼š

```python
# é…ç½®é€‰é¡¹
transition1_output_type: str = 'delta'  # 'delta' æˆ– 'absolute'
transition2_output_type: str = 'delta'  # 'delta' æˆ– 'absolute'
```

### 4.2 Deltaè¾“å‡ºï¼ˆé»˜è®¤æ¨èï¼‰

```python
# Transitioné¢„æµ‹å˜åŒ–é‡
delta_lift = Transition1(lift_with_state)
delta_splat = Transition2(lift, splat, actions)

# æœ€ç»ˆç‰¹å¾ = åŸå§‹ç‰¹å¾ + å˜åŒ–é‡
enhanced_lift = lift_features + delta_lift
enhanced_splat = splat_features + delta_splat
```

**Deltaè¾“å‡ºçš„ä¼˜åŠ¿**ï¼š
- âœ… **è®­ç»ƒç¨³å®š**ï¼šé¢„æµ‹å˜åŒ–é‡æ¯”é¢„æµ‹ç»å¯¹å€¼æ›´å®¹æ˜“
- âœ… **æ¢¯åº¦å‹å¥½**ï¼šé¿å…æ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸
- âœ… **ç‰©ç†æ„ä¹‰**ï¼šç¬¦åˆ"çŠ¶æ€å˜åŒ–"çš„ç‰©ç†ç›´è§‰
- âœ… **æ®‹å·®å­¦ä¹ **ï¼šç±»ä¼¼ResNetçš„æ®‹å·®è¿æ¥

### 4.3 Absoluteè¾“å‡º

```python
# Transitionç›´æ¥é¢„æµ‹ç›®æ ‡ç‰¹å¾
enhanced_lift = Transition1(lift_with_state)
enhanced_splat = Transition2(lift, splat, actions)
```

**Absoluteè¾“å‡ºçš„ä¼˜åŠ¿**ï¼š
- âœ… **è¡¨è¾¾èƒ½åŠ›å¼º**ï¼šå¯ä»¥è¿›è¡Œæ›´å¤§å¹…åº¦çš„ç‰¹å¾å˜æ¢
- âœ… **é€‚åˆæ›¿æ¢**ï¼šæŸäº›æƒ…å†µä¸‹éœ€è¦å®Œå…¨æ›¿æ¢ç‰¹å¾
- âœ… **çµæ´»æ€§é«˜**ï¼šä¸å—åŸå§‹ç‰¹å¾é™åˆ¶

### 4.4 è¾“å‡ºå½¢å¼çš„è‡ªé€‚åº”æ§åˆ¶

```python
# åœ¨forwardå‡½æ•°ä¸­çš„æ§åˆ¶é€»è¾‘
if self.config.transition1_output_type == 'delta':
    # è¾“å‡ºdeltaï¼Œéœ€è¦åŠ ä¸ŠåŸå§‹ç‰¹å¾
    enhanced_lift = lift_features + fusion_result['enhanced_lift']
    enhanced_splat = splat_features + fusion_result['enhanced_splat']
else:
    # è¾“å‡ºabsolute
    enhanced_lift = fusion_result['enhanced_lift']
    enhanced_splat = fusion_result['enhanced_splat']
```

## 5. å…³é”®åˆ›æ–°ç‚¹æ€»ç»“

### 5.1 ç†è®ºåˆ›æ–°

1. **é©¬å°”å¯å¤«æ€§è´¨ä¿æŒ**ï¼šé€šè¿‡å¤åˆéšçŠ¶æ€ç¼–ç å†å²ä¿¡æ¯
2. **åŒç©ºé—´å»ºæ¨¡**ï¼šè§†è§’ç©ºé—´+BEVç©ºé—´çš„åŒé‡æ—¶åºå»ºæ¨¡
3. **å±‚æ¬¡åŒ–äº¤äº’**ï¼šä¸åŒæŠ½è±¡å±‚æ¬¡çš„ç‰¹å¾äº¤äº’

### 5.2 æŠ€æœ¯åˆ›æ–°

1. **MarkovianHiddenState**ï¼šç¬¦åˆHMMç†è®ºçš„éšçŠ¶æ€è®¾è®¡
2. **DualTransitionFusion**ï¼šä¸‰ç§åˆ›æ–°èåˆç­–ç•¥
3. **åŠ¨æ€è¾“å‡ºæ§åˆ¶**ï¼šDelta/Absoluteè¾“å‡ºå½¢å¼è‡ªé€‚åº”
4. **è·¨ç©ºé—´ä¿¡æ¯æµ**ï¼šè§†è§’å‡ ä½•ä¿¡æ¯æŒ‡å¯¼BEVè¯­ä¹‰

### 5.3 å®ç”¨åˆ›æ–°

1. **å³æ’å³ç”¨**ï¼šä¸éœ€è¦ä¿®æ”¹ç°æœ‰LSSæ¶æ„
2. **é…ç½®çµæ´»**ï¼šæ”¯æŒå¤šç§èåˆç­–ç•¥å’Œè¾“å‡ºå½¢å¼
3. **ç†è®ºä¸¥è°¨**ï¼šç¬¦åˆHMMæ•°å­¦å®šä¹‰
4. **æ€§èƒ½ä¼˜è¶Š**ï¼šåœ¨ä¿æŒç†è®ºæ­£ç¡®æ€§çš„åŒæ—¶æå‡æ€§èƒ½

## 6. ä¸ç°æœ‰æ–¹æ³•çš„æœ¬è´¨åŒºåˆ«

### 6.1 ç›¸å¯¹äºBEVFormer
- **æˆ‘ä»¬**ï¼šåŸºäºHMMçš„çŠ¶æ€è½¬ç§»ï¼Œç†è®ºä¸¥è°¨
- **BEVFormer**ï¼šåŸºäºAttentionçš„ç‰¹å¾èåˆï¼Œç¼ºä¹ç†è®ºåŸºç¡€

### 6.2 ç›¸å¯¹äºBEVDet
- **æˆ‘ä»¬**ï¼šåŒç©ºé—´æ—¶åºå»ºæ¨¡ï¼Œå±‚æ¬¡åŒ–äº¤äº’
- **BEVDet**ï¼šå•ä¸€ç©ºé—´ç‰¹å¾å¯¹é½ï¼Œäº¤äº’æœ‰é™

### 6.3 ç›¸å¯¹äºå…¶ä»–æ—¶åºæ–¹æ³•
- **æˆ‘ä»¬**ï¼šç¬¦åˆé©¬å°”å¯å¤«æ€§è´¨çš„é•¿æœŸè®°å¿†
- **å…¶ä»–**ï¼šè¦ä¹ˆè¿åé©¬å°”å¯å¤«æ€§è´¨ï¼Œè¦ä¹ˆç¼ºä¹é•¿æœŸè®°å¿†

**è¿™è¯æ˜äº†æˆ‘ä»¬çš„æ–¹æ³•ç¡®å®å®ç°äº†çœŸæ­£çš„é•¿æœŸæ—¶åºå»ºæ¨¡å’ŒéšçŠ¶æ€è¡¨ç¤ºï¼**